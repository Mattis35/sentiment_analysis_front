# ============================================
# ğŸš€ WORKFLOW DE TEST + BUILD + DEPLOIEMENT RENDER
# ============================================
name: Deploy API

on:
  push:
    branches: [ "main" ]          # A chaque push sur main
  pull_request:
    branches: [ "main" ]          # PR vers main (tests uniquement)

jobs:
  # ==========================================
  # JOB 1 : TESTS ğŸ§ª
  # ==========================================
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # (facultatif) outils de test supplÃ©mentaires
          pip install pytest httpx

      - name: âœ… Smoke import
        run: |
          python - << 'PY'
          from main import app
          print("âœ… Import OK, app chargÃ©e.")
          PY

      # Utilise ta suite pytest (test_api.py)
      - name: ğŸ§ª Run pytest
        run: |
          pytest -v --maxfail=1

      # Mini smoke test inline avec TestClient sur tes VRAIS endpoints
      - name: ğŸ” Inline smoke endpoints
        run: |
          python - << 'PY'
          from fastapi.testclient import TestClient
          from main import app
          c = TestClient(app)

          # /health
          r = c.get("/health")
          assert r.status_code == 200, r.text
          j = r.json()
          assert "status" in j and j["status"] == "ok"
          print("âœ… /health OK")

          # /predict (payload simple)
          r = c.post("/predict", json={"text": "I love this product!"})
          assert r.status_code == 200, r.text
          data = r.json()
          for f in ["sentiment","confidence","probability_positive","probability_negative"]:
            assert f in data
          print("âœ… /predict OK")

          # /explain (si LIME dispo, sinon on tolÃ¨re 503)
          r = c.post("/explain", json={"text": "This is terrible!"})
          assert r.status_code in (200, 503), r.text
          print("âœ… /explain OK (status:", r.status_code, ")")
          PY

  # ==========================================
  # JOB 2 : BUILD ğŸ—ï¸
  # ==========================================
  build:
    name: ğŸ—ï¸ Build
    needs: test                      # ne tourne que si TEST ok
    runs-on: ubuntu-latest
    if: github.event_name == 'push'  # pas de build sur PR

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Verify dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… Dependencies OK"

      - name: ğŸ“‹ Check files
        run: |
          ls -la
          test -f main.py
          test -f requirements.txt
          # Artefacts (adapter selon ton repo)
          test -f sentiment_model.joblib || echo "âš ï¸ sentiment_model.joblib manquant (ok si tÃ©lÃ©chargÃ© autrement)"
          test -f tfidf_vectorizer.joblib || echo "â„¹ï¸ tfidf_vectorizer.joblib optionnel (pipeline?)"
          echo "âœ… Files OK"

  # ==========================================
  # JOB 3 : DEPLOY ğŸš€
  # ==========================================
  deploy:
    name: ğŸš€ Deploy to Render
    needs: [ test, build ]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ” Check deploy hook
        run: |
          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK }}" ]; then
            echo "âŒ Secret RENDER_DEPLOY_HOOK manquant. Ajoute-le dans Settings â†’ Secrets â†’ Actions."
            exit 1
          fi
          echo "âœ… Deploy hook present."

      - name: ğŸš€ Trigger Render deploy
        run: |
          curl -fsSL -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" && echo "âœ… Deploy triggered" || (echo "âŒ Deploy failed" && exit 1)

      - name: âœ… Deployment step done
        run: |
          echo "ğŸŒ VÃ©rifie le dashboard Render pour le statut du dÃ©ploiement."
